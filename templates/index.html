{% extends "base.html" %}
{% block title %}ä»ªå™¨ç®¡ç†ç³»ç»Ÿ - é¦–é¡µ{% endblock %}
{% block head %}
    <script src="https://cdn.staticfile.org/echarts/5.4.0/echarts.min.js"></script>
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dashboard-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .dashboard-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .stat-card.primary { border-left-color: #3498db; }
        .stat-card.success { border-left-color: #2ecc71; }
        .stat-card.warning { border-left-color: #f39c12; }
        .stat-card.danger { border-left-color: #e74c3c; }
        .stat-card.info { border-left-color: #9b59b6; }
        .stat-card.secondary { border-left-color: #95a5a6; }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 0;
            line-height: 1;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-icon {
            float: right;
            font-size: 2em;
            opacity: 0.3;
            margin-top: -10px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .dashboard-header h1 {
                font-size: 2em;
            }
        }
    </style>
{% endblock %}

{% block body %}
<div class="dashboard-header">
    <h1>ğŸ”¬ ä»ªå™¨ç®¡ç†ç³»ç»Ÿ</h1>
    <p>æ¬¢è¿å›æ¥ï¼Œ{{ name }}ï¼ä»Šå¤©æ˜¯ä¸€ä¸ªç®¡ç†ä»ªå™¨è®¾å¤‡çš„å¥½æ—¥å­</p>
</div>

<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-number" id="total-instruments">-</div>
        <div class="stat-label">ä»ªå™¨ç§ç±»</div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon">âœ…</div>
        <div class="stat-number" id="available-instruments">-</div>
        <div class="stat-label">å¯ç”¨è®¾å¤‡</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon">ğŸ“¤</div>
        <div class="stat-number" id="borrowed-instruments">-</div>
        <div class="stat-label">å·²å€Ÿå‡º</div>
    </div>
    <div class="stat-card info">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-number" id="total-users">-</div>
        <div class="stat-label">æ³¨å†Œç”¨æˆ·</div>
    </div>
    <div class="stat-card danger">
        <div class="stat-icon">âš ï¸</div>
        <div class="stat-number" id="overdue-count">-</div>
        <div class="stat-label">é€¾æœŸæœªè¿˜</div>
    </div>
    <div class="stat-card secondary">
        <div class="stat-icon">ğŸ“ˆ</div>
        <div class="stat-number" id="today-activity">-</div>
        <div class="stat-label">ä»Šæ—¥æ´»åŠ¨</div>
    </div>
</div>

<div class="charts-container">
    <div class="chart-card">
        <div class="chart-title">ğŸ“ˆ è¿‘10å¤©å€Ÿè¿˜è¶‹åŠ¿</div>
        <div id="trend-chart" style="width: 100%; height: 350px;"></div>
    </div>
    <div class="chart-card">
        <div class="chart-title">ğŸ·ï¸ ä»ªå™¨ç±»åˆ«åˆ†å¸ƒ</div>
        <div id="category-chart" style="width: 100%; height: 350px;"></div>
    </div>
</div>

<div class="charts-container" style="margin-top: 20px;">
    <div class="chart-card">
        <div class="chart-title">ğŸ“Š è®¾å¤‡ä½¿ç”¨ç‡æ’è¡Œ</div>
        <div id="usage-chart" style="width: 100%; height: 350px;"></div>
    </div>
    <div class="chart-card">
        <div class="chart-title">ğŸ‘¤ ç”¨æˆ·æ´»è·ƒåº¦</div>
        <div id="user-activity-chart" style="width: 100%; height: 350px;"></div>
    </div>
</div>

{% endblock %}
{% block script %}
<script>
// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    loadStatistics();

    // åˆå§‹åŒ–å›¾è¡¨
    initTrendChart();
    initCategoryChart();
    initUsageChart();
    initUserActivityChart();
});

// åŠ è½½ç»Ÿè®¡æ•°æ®
function loadStatistics() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-instruments').textContent = data.total_instruments || 0;
            document.getElementById('available-instruments').textContent = data.available_instruments || 0;
            document.getElementById('borrowed-instruments').textContent = data.borrowed_instruments || 0;
            document.getElementById('total-users').textContent = data.total_users || 0;
            document.getElementById('overdue-count').textContent = data.overdue_count || 0;
            document.getElementById('today-activity').textContent = data.today_activity || 0;
        })
        .catch(error => {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        });
}

// åˆå§‹åŒ–è¶‹åŠ¿å›¾è¡¨
function initTrendChart() {
    const chart = echarts.init(document.getElementById('trend-chart'));

    chart.setOption({
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data: ['å€Ÿå‡º', 'å½’è¿˜']
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: []
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'å€Ÿå‡º',
                type: 'line',
                stack: 'Total',
                smooth: true,
                lineStyle: {
                    color: '#3498db'
                },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(52, 152, 219, 0.3)' },
                            { offset: 1, color: 'rgba(52, 152, 219, 0.1)' }
                        ]
                    }
                },
                data: []
            },
            {
                name: 'å½’è¿˜',
                type: 'line',
                stack: 'Total',
                smooth: true,
                lineStyle: {
                    color: '#2ecc71'
                },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(46, 204, 113, 0.3)' },
                            { offset: 1, color: 'rgba(46, 204, 113, 0.1)' }
                        ]
                    }
                },
                data: []
            }
        ]
    });

    // åŠ è½½è¶‹åŠ¿æ•°æ®
    fetch('/api/trend-data')
        .then(response => response.json())
        .then(data => {
            chart.setOption({
                xAxis: {
                    data: data.dates
                },
                series: [
                    { data: data.borrow_counts },
                    { data: data.return_counts }
                ]
            });
        })
        .catch(error => {
            console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
        });
}

// åˆå§‹åŒ–ç±»åˆ«åˆ†å¸ƒå›¾è¡¨
function initCategoryChart() {
    const chart = echarts.init(document.getElementById('category-chart'));

    chart.setOption({
        tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left'
        },
        series: [
            {
                name: 'ä»ªå™¨ç±»åˆ«',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: '18',
                        fontWeight: 'bold'
                    }
                },
                labelLine: {
                    show: false
                },
                data: []
            }
        ]
    });

    // åŠ è½½ç±»åˆ«æ•°æ®
    fetch('/api/category-data')
        .then(response => response.json())
        .then(data => {
            chart.setOption({
                series: [{
                    data: data
                }]
            });
        })
        .catch(error => {
            console.error('åŠ è½½ç±»åˆ«æ•°æ®å¤±è´¥:', error);
        });
}

// åˆå§‹åŒ–ä½¿ç”¨ç‡å›¾è¡¨
function initUsageChart() {
    const chart = echarts.init(document.getElementById('usage-chart'));

    chart.setOption({
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'value'
        },
        yAxis: {
            type: 'category',
            data: []
        },
        series: [
            {
                name: 'ä½¿ç”¨æ¬¡æ•°',
                type: 'bar',
                data: [],
                itemStyle: {
                    color: function(params) {
                        const colors = ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'];
                        return colors[params.dataIndex % colors.length];
                    }
                }
            }
        ]
    });

    // åŠ è½½ä½¿ç”¨ç‡æ•°æ®
    fetch('/api/usage-data')
        .then(response => response.json())
        .then(data => {
            chart.setOption({
                yAxis: {
                    data: data.names
                },
                series: [{
                    data: data.values
                }]
            });
        })
        .catch(error => {
            console.error('åŠ è½½ä½¿ç”¨ç‡æ•°æ®å¤±è´¥:', error);
        });
}

// åˆå§‹åŒ–ç”¨æˆ·æ´»è·ƒåº¦å›¾è¡¨
function initUserActivityChart() {
    const chart = echarts.init(document.getElementById('user-activity-chart'));

    chart.setOption({
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['å€Ÿç”¨æ¬¡æ•°']
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: []
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'å€Ÿç”¨æ¬¡æ•°',
                type: 'bar',
                data: [],
                itemStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ]
                    }
                }
            }
        ]
    });

    // åŠ è½½ç”¨æˆ·æ´»è·ƒåº¦æ•°æ®
    fetch('/api/user-activity-data')
        .then(response => response.json())
        .then(data => {
            chart.setOption({
                xAxis: {
                    data: data.names
                },
                series: [{
                    data: data.values
                }]
            });
        })
        .catch(error => {
            console.error('åŠ è½½ç”¨æˆ·æ´»è·ƒåº¦æ•°æ®å¤±è´¥:', error);
        });
}
</script>
{% endblock %}